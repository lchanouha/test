= Design Patterns - TP 1
J.-M. Bruel <jbruel@gmail.com>
v20.1 {localdate}
:uk!:
:tdnum: TP1
:imagesdir: images

//------------------------- variables de configuration
// only used when master document
:icons: font
:experimental:
:numbered!:
:status:
:baseURL: https://github.com/LP-APSIO/MobileModeling2020
:github: https://github.com[GitHub]
:asciidoctorlink: http://asciidoctor.org/[Asciidoctor]indexterm:[Asciidoctor]
:asciidoc: http://www.methods.co.nz/asciidoc[AsciiDoc]indexterm:[AsciiDoc]
:ant: https://ant.apache.org/[Ant(TM)]

// Specific to GitHub
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
//------------------------------------ 
ifdef::uk[]
:lang: uk
:lastName: LAST NAME
:firstName: First Name
:group: Group
:example: Example
:Enseignants: Teachers
:principe: Good design principle
:assignment: Assignment info
:requirements: Requirements
:initial: Initial tasks
:allerPlusLoin: Still hungry?...
:about: About...
endif::[]
ifndef::uk[]
:lang: fr
:lastName: NOM
:firstName: Prénom
:group: Groupe
:example: Exemple
:Enseignants: Enseignants
:principe: Principe Objet
:assignment: Informations générales
:requirements: Pré-requis
:initial: Tâche initiale
:allerPlusLoin: Pour Aller plus loin...
:about: À propos...
endif::[]
:java: https://www.java.com/fr/[Java]
//------------------------------------ 

ifdef::uk[]
== {tdnum} initial code
This is a template for the students' assignments.

TIP: Course material: pass:[<i class="fa fa-mobile"></i> <i class="fa fa-tablet"></i> <i class="fa fa-laptop"></i>] http://bit.ly/jmb-cpoa
endif::[]
ifndef::uk[]
== Code initial pour le {tdnum}

TIP: Rappel du cours : pass:[<i class="fa fa-mobile"></i> <i class="fa fa-tablet"></i> <i class="fa fa-laptop"></i>] http://bit.ly/jmb-cpoa
endif::[]


//------------------------------------ 
== {assignment}

{lastName}:: BRUEL

{firstName}:: Jean-Michel

{group} #::

[%interactive]
- [x] {Enseignants}
- [ ] 1
- [ ] 2
- [ ] 3
- [ ] 4
- [ ] Innopolis

//------------------------------------ 
== {requirements}

ifdef::uk[]
You'll need:

[%interactive]
* [x] A {Github} account  
* [ ] A https://gitforwindows.org/[Git Bash] terminal (if you use Window$)
endif::[]
ifndef::uk[]
Il vous faut :

[%interactive]
* [x] Un compte {Github}  
* [ ] Un terminal de type https://gitforwindows.org/[Git Bash]  (si vous utilisez Window$)
endif::[]

ifdef::uk[]
[TIP]
====    
Try the following command in your terminal to check your `git` environment:
endif::[]
ifndef::uk[]
[TIP]
====    
Essayez la commande suivante dans votre terminal pour vérifier votre environnement `git` :
endif::[]

[source,shell]
....
git config --global -l
....
====

//------------------------------------ 
== {initial}

ifdef::uk[]
[%interactive]
* [x] Click on the Github Classroom link provided by your teacher (in fact, this should be done if you read this).
* [ ] Clone on your machine the Github project generated by Github Classroom.  
* [ ] Modify the README file to add your last name, first name and group number. 
* [ ] Commit and push using the following message:
endif::[]
ifndef::uk[]
[%interactive]
* [x] Clickez sur le lien Github Classroom fourni par votre enseignant (en fait c'est déjà fait si vous lisez ces lignes).
* [ ] Clonez sur votre machine le projet Github généré pour vous par Github Classroom.  
* [ ] Modifez le `README` pour modifier Nom, Prénom et Groupe. 
* [ ] Commit & push:
endif::[]

ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #0 Initial task done
....

[IMPORTANT]
ifndef::uk[]
Dans la suite de ce document, à chaque fois que vous trouverez un énoncé commençant par `fix #...` vous devez vérifier que vos scripts/fichiers modifiés sont bien dans votre dépôt local en vue de committer et de pusher les modifications sur votre dépôt distant en utilisant comme message de commit cet énoncé.

[TIP]
====
- Si vous voulez vérifier que vous êtes prêt pour le `fix #0`, utilisez la commande : `make check`.
- Si vous voulez avoir la liste des ToDos de ce TP/TP, exécutez `make todos`.
====
endif::[]
ifdef::uk[]
In the following, every time you'll see à `fix #...` text, 
make sure all your files are committed, and then push your modifications in the distant repo, making sure you used the corresponding message (`fix #...`) in one of the `commit` messages.

[TIP]
====
- If you want to check that you're really ready for `fix #0`, you can run the command in your shell: `make check`.
- If you want to list the ToDos of the day, run `make todos`.
====
endif::[]

//------------------------------------ 
//------------------------------------ 
//------------------------------------ 
//------------  Let's START----------- 
//------------------------------------ 
//------------------------------------ 


:numbered:
//------------------------------------ 
== Le jeux d'aventure

=== Les bases

. En utilisant le patron _Strategy_, et en utilisant l'organisation en
paquetage donnée en <<setArme,fin de TP>>), implémentez les classes et comportements du jeu d'aventure
du TD1 (section 1.7.2) et dont voici les bases :
+
.Un jeu d'aventure minimaliste
image::aventure.png[link="images/aventure.png"]


ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix 1.1: Initial Adventure Game
....


=== Améliorations

On souhaite maintenant obliger les concepteurs de tout nouveau `Personnage` à
implémenter systématiquement à l'instanciation le comportement d'arme.

. Proposez une solution à ce problème
+
TIP: il est tout à fait légal de créer un constructeur pour une classe abstraite...
+
. Implémentez cette solution en modifiant votre application
. Testez d'ajouter une nouvelle classe de `Personnage` qui n'implémente pas le comportement
et vérifiez que ça ne passe pas la compilation.
+
ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix 1.2: Initial Adventure Game
....


=== Utilisation du comportement dynamique

On souhaite pleinement bénéficier du changement possible de comportement
à l'exécution.

. Réalisez une application qui, à partir d'un menu, permet de créér
un personnage parmis les types possibles, et de lui affecter une arme.
. Vérifiez qu'en changeant d'arme, le comportement change.

ifdef::env-github[.:heavy_exclamation_mark: commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix 1.3: Dynamic Behavior
....

=== _Reverse engineering_ du code

TIP: Lire la section <<reverse>> avant d'attaquer cette partie.

Le rendu de ce TP doit se faire sous la forme du diagramme de classe de votre application finale.

Pour cela utilisez les fichiers disponibles en début de ce TP et de l'une des techniques
suivantes (*`build.xml` recommandée*) :

- Utilisation de {ant} :
+
[source,ant]
----
include::util/build.xml[]
----
+
[WARNING]
====
// Merci André! Merci Louis!
Attention, si le script ne fonctionne pas avec java `1.8`, c'est que
vous avez la version officielle de la doclet plantuml et non la version patchée par Louis Chanouha ().
Dans ce cas-là, pour que ça fonctionne, indépendamment du jre utilisé dans le projet {Eclipse} (7 ou 8),
on a deux solutions :

* Utiliser {ant} en ligne de commande :
** Dans Windows : se mettre en java 7, le mieux est avant de démarrer {Eclipse} de la façon suivante :
menu:Démarrer[Tous les programmes > Java > Version Java par défaut] puis Sélectionner la version 7.
+
image::plantuml1.7.png[width=50%]
+
** Vérifier dans une fenêtre de commande : `java -version` => 1.7
** Travailler dans Eclipse (classes, comments, créer le build, mettre les jar, ...)
** Dans la fenêtre de commande :
*** se positionner dans le répertoire du `build.xml`
*** taper la commande : `ant`
** Ca doit être ok (refresh dans {Eclipse} si besoin)
** Dans {eclipse} :
*** Peut importe le jre utilisé pour le projet
*** Dans les paramètres de lancement du build (`Run as ...` ou `Ant Build ...`) :
**** Créer la variable `path` vers `C:\Programmes\java\jdk1.7.xxx.xxx\bin`
+
image::runas.png[width=80%]
+
WARNING: pas vers le lien windows `jdk1.7\bin` qui existe, pas `jdk1.8.xx`
+
**** Modifier dans la même fenêtre, dans l'onglet JRE, le JRE utilisé pour exécuter le build
***** Prendre Seperate jre => 7
***** Si besoin : installer la jre 7 (toujours pareil : `C:\Programmes\java\jre1.7.xx.xx`
et pas le lien windows vers jre1.7)
*** Ca doit marcher
====

- Utilisation d'un script Windows
+
.Exemple de `.BAT` qui devrait fonctionner
[source,shell]
----
set UML=TP1.plantuml
set TYPE='PNG'
set DOCLETPATH=
echo "Creating %UML%..."

javadoc -J-DdestinationFile=%UML% -J-DcreatePackages=false
-J-DshowPublicMethods=true -J-DshowPublicConstructors=false
-J-DshowPublicFields=true -doclet de.mallox.doclet.PlantUMLDoclet
-docletpath plantUmlDoclet.jar src/appli/*.java
src/comportements/arme/*.java src/comportements/arme/impl/*.java
src/personnages/*.java
echo "Done."

set TYPE='png'
echo "Converting %UML% to $TYPE..."
java -jar plantuml.jar -config "config.cfg" -t %TYPE% %UML%
echo "Done."
----
+
- Utilisation d'un script shell équivalent au précédent (cf. <<plantumlShell,plantuml.sh>>)
- Utilisation de la nouvelle doclet : https://github.com/gboersma/uml-java-doclet
- Si vous n'avez pas le temps ou si aucune méthode ne fonctionne, obtenez votre diagramme de classe à partir d'eclipse avec le plugin plantUML (attention, choisir
menu:Window[Show View > Other... > PlantUML > PlantUML Source]).

//----------------------------- Question ------------------
.*TODO*:
[WARNING]
====
[%interactive]
* [ ] Placez le code plantUML de votre application dans le répertoire `doc` et nommez-le : `TP1.plantuml`
* [ ] Quand tout est bon, poussez votre code :
+
ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix 1.4: Final TP1 commit
....
+
* [ ] Vérifier l'autograding de votre repo
====


:numbered!:
[appendix]
[[setWeapon]]

== Exemple d'organisation en paquetages

Le principe est d'avoir :

- un _package_ pour les classes métiers (e.g., `Canard`,`Colvert`, etc.)
- un autre pour les comportements (1 par type de comportement en fait)
- dans chaque comportement avoir l'interface, puis un _package_ spécifique
aux implémentations (`impl`).

Ce qui donne pour l'application `SuperCanard` :

[source,shell]
-------
        ├── appli
        │   ├── Canard.java
        │   ├── CanardEnPlastique.java
        │   ├── Colvert.java
        │   ├── Leurre.java
        │   ├── Main.java
        │   └── Mandarin.java
        └── behaviors
            ├── cancaner
            │   ├── BehaviorCancan.java
            │   └── impl
            │       ├── CanardMuet.java
            │       ├── Cancan.java
            │       └── Coincoin.java
            └── voler
                ├── BehaviorVol.java
                └── impl
                    ├── NePasVoler.java
                    └── VolerAvecDesAiles.java
-------

[WARNING]
====
 Pour avoir une vue hiérarchique des packages dans eclipse, cf. https://stackoverflow.com/questions/3915961/how-to-view-hierarchical-package-structure-in-eclipse-package-explorer

image::packagesHierarchy.png[width=50%]
====

reverse]]
[appendix]
== Modèles et tests d'architecture

=== Principes de base

En utilisant la doclet pour Javadoc de {plantUML}, il est possible d'obtenir
le diagramme de classe correspondant à son architecture de manière automatique.

NOTE: Vous aurez également besoin du fichier link:util/config.cfg[config.cfg].

=== Exemple

Prenons l'exemple de l'application `SuperCanardBof`.

NOTE: Vous ne devez pas générer de modèle pour vos cabards, mais pour votre
jeux d'aventure. Ce qui suit est juste une illustration de ce que vous devez faire pour
votre application de jeu.

On peut écrire le script suivant :

.Génération automatique de diagramme PlantUML (cf. <<utils>>)
[source,shell]
---------
include::src/java/SuperCanardBof/plantuml.bat[]
---------

Ce qui permet d'obtenir automatiquement le diagramme suivant :

.Modèle de l'application `SuperCanardBof` (généré automatiquement)
image::superCanardBofGenerated.png[width=90%,link=images/superCanardBofGenerated.png]

TIP: Observez dans les sources des fichiers Java comment il est possible d'ajouter
des éléments directement dans le code à destination du plantUML généré.

L'intérêt est double :

- le modèle est par définition conforme au code
- on peut le tester :-)

Voici un exemple simple de test qui vérifie quelques points simples de
l'architecture de l'application :

.Test du modèle UML généré en Ruby (source link:src/java/SuperCanardBof/checkModel.rb[ici])
[source,ruby]
----------
include::src/java/SuperCanardBof/checkModel.rb[lines=8..200]
----------

Ce qui donne le résultat :

...............
$ ruby checkModel.rb
MiniTest::Unit::TestCase is now Minitest::Test. From checkModel.rb:12:in `<main>'
Run options: --seed 21820

# Running:

...

Finished in 0.002029s, 1478.5609 runs/s, 1478.5609 assertions/s.

3 runs, 3 assertions, 0 failures, 0 errors, 0 skips
...............

Si vous voulez vérifier que votre modèle d'architecture est bien conforme
à ce qui est demandé, vous pouvez utiliser le programme de test suivant :

.Test du patron _Strategy_ sur les `Canard` en Ruby (source link:src/java/TD1/checkModel.rb[ici])
[source,ruby]
----------
include::src/java/TD1/checkModel.rb[lines=8..200]
----------

=== Limitations

Si vous avez observé le diagramme obtenu, vous verrez qu'il n'y a pas
les associations (ni les dépendances). Plutôt que d'aller les rajouter
"à la main", vous pouvez utiliser les annotations plantUML, comme par exemple :

[source,java]
-------
/**
* @extends Controller
* @extends EmbeddedAgent
* @navassoc - - 1..* PowerManager
* @note this is a note
*/
class SetTopController implements URLStreamHandler {
  public String name;

  int authorizationLevel;
  void startUp() {}
    void shutDown() {}
      void connect() {}
      }
-------

Utilisez les annotations pour compléter vos codes Java de façon
à générer un diagramme de classe le plus complet possible.


[appendix]
== {allerPlusLoin}

. Testez les limites de votre implémentation (par exemple avez-vous pensé à
  ce qui se passe si quelqu'un fait un `new Chevalier(null,null)` ?).
. Vous pouvez imaginer une application graphique :-)
. Repérez la partie de votre application principale qui fait le lien entre une arme
donnée et le comportement à affecter au personnage. Comment pourrait-on améliorer cette
"correspondance"?
. Proposez éventuellement des tests complémentaires dans `./tests` pour améliorer l'autograding.

ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix 1.5: Donnez-moi un bonus: [please explain why ;-)]
....





ifndef::compact[]
//------------------------------------ 
== Contributors
//------------------------------------ 

- mailto:jbruel@gmail.com[Jean-Michel Bruel]

== About...

****************************************************************
Document réalisé via  {asciidoctorlink} (version `{asciidoctor-version}`) de 'Dan Allen', lui même basé sur {asciidoc}.
Libre d'utilisation et géré par la 'Licence Creative Commons'.
image:88x31.png["Licence Creative
Commons",style="border-width:0",link="http://creativecommons.org/licenses/by-sa/3.0/"]
http://creativecommons.org/licenses/by-sa/3.0/[licence Creative Commons Paternité - Partage à l&#39;Identique 3.0 non transposé].
****************************************************************
endif::compact[]
